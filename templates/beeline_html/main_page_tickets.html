{% extends '_base.html' %}
{% load static %}
{% block title %}Главная страница{% endblock %}
{% block content %}
    <div class="container">
        <button type="button" class="btn btn-primary" style="cursor: context-menu;">
            Созданных сегодня <span class="badge badge-light">{{ created_today_tickets }}</span>
        </button>
        <button type="button" class="btn btn-warning" style="cursor: context-menu;">
            Назначенных сегодня <span class="badge badge-light" id="assigned_today_counter">{{ assigned_today }}</span>
        </button>
        <button type="button" class="btn btn-success" style="cursor: context-menu;">
            Подключенных сегодня <span class="badge badge-light" id="switched_today_counter">{{ switched_on_today }}</span>
        </button>
        <button type="button" class="btn btn-secondary" style="cursor: context-menu;">
            Подключенных всего <span class="badge badge-light" ><switched_count></switched_count></span>
        </button>
        <button type="button" class="btn btn-info" style="cursor: context-menu;">
            {{ timestamp }}
        </button>

    </div>
    <hr>
    <div class="container">
        <input class="form-control" id="myInput" type="text" placeholder="Search..">
    </div>
    <hr>
    <ol class="breadcrumb my-4">
        <li class="breadcrumb-item active"><span class="label label-danger">Назначенные в график: </span>
            <result_assign></result_assign>
        </li>
    </ol>
    <div class="container">
        <table id="assign_table" class="table table-hover table-bordered table-warning">
            <thead class="thead-inverse" style="background: #ffc620">
            <tr>
                <th>Номер заявки</th>
                <th>ФИО\Адресс</th>
                <th>Телефон</th>
                <th>Статус</th>
                <th>Таймер</th>
                <th>Сотрудник</th>
            </tr>
            </thead>
            <tbody id="myTable">
            {% for ticket in assigned_tickets %}
                <tr>
                    <td class="align-middle "><a href="{% url 'ticket_info' ticket.ticket_paired_info.id %}"
                                                 target="_blank">{{ ticket.ticket_paired_info.number }}</a>
                        <small class="text-muted d-block">{{ ticket.status }}</small>
                    </td>

                    <td>
                        <a class="align-middle">{{ ticket.name }}</a>
                        <small class="text-muted d-block">{{ ticket.address }} <b
                                style="color:red;">{{ ticket.dns }}</b> </small>
                        <small id="installer_comments_{{ ticket.ticket_paired_info.id }}">

                        </small>
                    </td>
                    <td>
                        <a class="align-middle" href="tel:8{{ ticket.phone1 }}">{{ ticket.phone1 }}</a>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone2 }}">{{ ticket.phone2 }}</a></small>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone3 }}">{{ ticket.phone3 }}</a></small>
                    </td>
                    <td class="align-middle">
                        {{ ticket.ticket_paired_info.status }}
                        <small class="text-muted d-block">
{#                            тариф#}
{#                            {{ ticket.services.IS_PRESET_name }}{{ ticket.services.IS_INAC_PRESET_name }}#}
                        </small>
                    </td>
                    <td class="align-middle">
                        {{ ticket.call_time }}
                        <small class="text-muted d-block"><abbr id="assign_date_{{ ticket.ticket_paired_info.id }}"
                                title="Последняя дата назначения">
{#                            {{ ticket.assigned_date }}#}
                        </abbr></small>
                    </td>
                    <td class="align-middle" data-operator="{{ ticket.operator }}">
                        {{ ticket.name_operator }}
                        <div class="input-group input-group-sm">
                            <select class="source-select custom-select" style="background-color: red;"
                                    data-ticket_paired_info_number={{ ticket.ticket_paired_info.number }}
                                    id="source_{{ ticket.ticket_paired_info.number }}">
                                <option>Не определено</option>
                                <option>Поквартирный обход</option>
                                <option>Обзвон</option>
                                <option>Залистовка</option>
                                <option>Другое</option>
                            </select>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <ol class="breadcrumb my-4">
        <li class="breadcrumb-item active"><span class="label label-danger">Перезвоны на сегодня: </span>
            <result_call></result_call>
        </li>
        <li class="ml-auto">
            <div id="permission_div" style="display: block;">
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored"
                        onclick="requestPermission()">PUSH Уведомления
                </button>
            </div>
            <button class="btn btn-warning btn-sm" onclick="getCallTariff()"> Показать тарифы</button>
        </li>
    </ol>
    <div class="container">
        <table id="call_table" class="table table-hover table-bordered table-info">
            <thead class="thead-inverse" style="background: #00ecff">
            <tr>
                <th>Номер заявки</th>
                <th>ФИО\Адресс</th>
                <th>Телефон</th>
                <th>Статус</th>
                <th>Таймер</th>
                <th>Сотрудник</th>
            </tr>
            </thead>
            <tbody id="myTable">
            {% for ticket in call_for_today %}
                <tr>
                    <td class="align-middle "><a href="{% url 'ticket_info' ticket.ticket_paired_info.id %}"
                                                 target="_blank">{{ ticket.ticket_paired_info.number }}
                    </a>
                    </td>
                    <td>
                        <a class="align-middle">{{ ticket.name }}</a>
                        <span>
                                                    {% if ticket.is_expired %}
                                                        <span>&#128680;</span>
                                                    {% endif %}
                        </span>
                        <small class="text-muted d-block">{{ ticket.address }}</small>
                    </td>
                    <td>
                        <a class="align-middle" href="tel:8{{ ticket.phone1 }}">{{ ticket.phone1 }}</a>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone2 }}">{{ ticket.phone2 }}</a></small>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone3 }}">{{ ticket.phone3 }}</a></small>
                    </td>
                    <td class="align-middle">{{ ticket.ticket_paired_info.status }}
                        <small class="text-muted d-block" id="t_{{ ticket.id }}"></small>
                    </td>
                    <td class="align-middle">{{ ticket.ticket_paired_info.call_time }}</td>
                    <td class="align-middle" data-operator="{{ ticket.operator }}">{{ ticket.name_operator }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <ol class="breadcrumb my-4">
        <li class="breadcrumb-item active"><span class="label label-danger">Подключенные: </span>
            <result_switch></result_switch>
        </li>
        <li class="ml-auto">
            <button class="btn btn-warning btn-sm" onclick="getSwitchedTariff()"> Показать тарифы</button>
        </li>
    </ol>
    <div class="container">
        <table id="switch_table" class="table table-hover table-bordered table-success">
            <thead class="thead-inverse" style="background: #a3ff0a">
            <tr>
                <th>Номер заявки</th>
                <th>ФИО\Адресс</th>
                <th>Телефон</th>
                <th>Статус</th>
                <th>Таймер</th>
                <th>Сотрудник</th>
            </tr>
            </thead>
            <tbody id="myTable">
            {% for ticket in switched_on_tickets %}
                <tr>
                    <td class="align-middle "><a href="{% url 'ticket_info' ticket.ticket_paired_info.id %}"
                                                 target="_blank">{{ ticket.ticket_paired_info.number }}</a>
                        <small class="text-muted d-block"><a href="{% url 'ticket_info' ticket.id %}"
                                                             target="_blank">{{ ticket.number }}</a></small>
                    </td>
                    <td>
                        <a class="align-middle">{{ ticket.name }}</a>
                        <small class="text-muted d-block">{{ ticket.address }} <b
                                style="color:red;">{{ ticket.dns }}</b></small>
                    </td>
                    <td>
                        <a class="align-middle" href="tel:8{{ ticket.phone1 }}">{{ ticket.phone1 }}</a>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone2 }}">{{ ticket.phone2 }}</a></small>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone3 }}">{{ ticket.phone3 }}</a></small>
                    </td>
                    <td class="align-middle">
                        {{ ticket.ticket_paired_info.status }}
                        <small class="text-muted d-block" id="t_{{ ticket.id }}"></small>
                    </td>
                    <td class="align-middle">{{ ticket.ticket_paired_info.call_time }}</td>
                    <td class="align-middle" data-operator="{{ ticket.operator }}">
                        {{ ticket.name_operator }}
                        <div class="input-group input-group-sm" >
                            <select class="source-select custom-select" style="background-color: red;"
                                    data-ticket_paired_info_number={{ ticket.ticket_paired_info.number }}
                                    id="source_{{ ticket.ticket_paired_info.number }}">
                                <option>Не определено</option>
                                <option>Поквартирный обход</option>
                                <option>Обзвон</option>
                                <option>Залистовка</option>
                                <option>Другое</option>
                            </select>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
{% block extra_scripts %}
    <script src="{% static 'js/beeline_js/index.js' %}"></script>
    <script>
        $(function () {
            $('#call_table').excelTableFilter();
            searchLine();
            assignCounter();
            switchCounter();
            $(".source-select").on("change", function (e) {
                let ticket_paired_info_number = $(this).data('ticket_paired_info_number')
                let operator = $(this).parent().parent().data('operator')
                sendSourceTicket(operator,
                    ticket_paired_info_number,
                    document.getElementById(`source_${ticket_paired_info_number}`),
                    '{{ csrf_token }}')
                $(this).css('background', 'transparent')
            });
        });
        getCallTariff = () => {
            {% for ticket in call_for_today %}
                getTicketInfo({{ticket.id}});
            {% endfor %}
        };
        getSwitchedTariff = () => {
            {% for ticket in switched_on_tickets %}
                getTicketInfo({{ticket.id}});
            {% endfor %}
        };
        //show source for all switched tickets and assigned
        let promise1 = new Promise(function (resolve, reject) {
            {% for ticket in assigned_tickets %}
                showSourceTicket({{ticket.ticket_paired_info.number}});
                autoUpdateInstallerComments({{ ticket.ticket_paired_info.id }}, '{{ csrf_token }}');
            {% endfor %}
        });
        promise1.then(function () {
            getCountAssigned();
        });
        {% for ticket in switched_on_tickets %}
            showSourceTicket({{ticket.ticket_paired_info.number}});
        {% endfor %}
    </script>
    <!-- START INITIALIZATION CODE -->
<script src="https://www.gstatic.com/firebasejs/4.1.2/firebase.js"></script>
<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyBU1BxUS0t23biciabryhILTccxZlnMkI0",
    authDomain: "partnerweb3-285816.firebaseapp.com",
    databaseURL: "https://partnerweb3-285816.firebaseio.com",
    projectId: "partnerweb3-285816",
    storageBucket: "partnerweb3-285816.appspot.com",
    messagingSenderId: "166059741652",
    appId: "1:166059741652:web:be532d917b9557ea9e0641",
    measurementId: "G-YF11CTXN7Y"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
</script>
<script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
<!-- END INITIALIZATION CODE -->
<!-- ******************************************************** -->
<script>
  // [START get_messaging_object]
  // Retrieve Firebase Messaging object.
  const messaging = firebase.messaging();
  // [END get_messaging_object]

  // IDs of divs that display Instance ID token UI or request permission UI.
  const tokenDivId = 'token_div';
  const permissionDivId = 'permission_div';

  // [START refresh_token]
  // Callback fired if Instance ID token is updated.
  messaging.onTokenRefresh(function() {
    messaging.getToken()
    .then(function(refreshedToken) {
      console.log('Token refreshed.');
      // Indicate that the new Instance ID token has not yet been sent to the
      // app server.
      setTokenSentToServer(false);
      // Send Instance ID token to app server.
      sendTokenToServer(refreshedToken);
      // [START_EXCLUDE]
      // Display new Instance ID token and clear UI of all previous messages.
      resetUI();
      // [END_EXCLUDE]
    })
    .catch(function(err) {
      console.log('Unable to retrieve refreshed token ', err);
    });
  });
  // [END refresh_token]

  // [START receive_message]
  // Handle incoming messages. Called when:
  // - a message is received while the app has focus
  // - the user clicks on an app notification created by a sevice worker
  //   `messaging.setBackgroundMessageHandler` handler.
  messaging.onMessage(function(payload) {
    console.log("Message received. ", payload);
    // [START_EXCLUDE]
    // Update the UI to include the received message.
    appendMessage(payload);
    // [END_EXCLUDE]
  });
  // [END receive_message]

  function resetUI() {
    // [START get_token]
    // Get Instance ID token. Initially this makes a network call, once retrieved
    // subsequent calls to getToken will return from cache.

    console.log("getting token")
    messaging.getToken().then((resp) => {
      console.log(resp)
    })
    messaging.getToken()
    .then(function(currentToken) {
      console.log("Got current token")
      if (currentToken) {
        sendTokenToServer(currentToken);
        updateUIForPushEnabled(currentToken);
      } else {
        // Show permission request.
        console.log('No Instance ID token available. Request permission to generate one.');
        // Show permission UI.
        updateUIForPushPermissionRequired();
        setTokenSentToServer(false);
      }
    })
    .catch(function(err) {
      console.log('An error occurred while retrieving token. ', err);
      setTokenSentToServer(false);
    });
    console.log("End get token")

  }
  // [END get_token]


  // Send the Instance ID token your application server, so that it can:
  // - send messages back to this app
  // - subscribe/unsubscribe the token from topics
  function registerDevice(currentToken) {
      return $.ajax({
          url: `/devices/`,
          type: 'POST',
          contentType: 'application/json; charset=utf-8',
          beforeSend: function (xhr) {
              xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
          },
          data: JSON.stringify({
              'registration_id': currentToken,
              'type': 'web',
          }),
          dataType: 'json',
          success: function (data) {
              return data
          }
      })
  }
  function sendTokenToServer(currentToken) {
    if (!isTokenSentToServer()) {
        console.log('Sending token to server...');
        registerDevice(currentToken).then(function (response) {
            alert(response);
        })
        setTokenSentToServer(true);
    }
    else {
      console.log('Token already sent to server so won\'t send it again ' +
          'unless it changes');
    }

  }

  function isTokenSentToServer() {
    if (window.localStorage.getItem('sentToServer') == 1) {
          return true;
    }
    return false;
  }

  function setTokenSentToServer(sent) {
    if (sent) {
      window.localStorage.setItem('sentToServer', 1);
    } else {
      window.localStorage.setItem('sentToServer', 0);
    }
  }

  function requestPermission() {
    console.log('Requesting permission...');
    // [START request_permission]
    messaging.requestPermission()
    .then(function() {
      console.log('Notification permission granted.');
    })
    .catch(function(err) {
      console.log('Unable to get permission to notify.', err);
    });
    // [END request_permission]
  }
  resetUI();
</script>
{% endblock %}













