{% extends '_base.html' %}
{% load static %}
{% block title %}Главная страница{% endblock %}
{% block content %}
    <div class="container">
        <p>
            <span id='assign_total' class="badge badge-warning"><assigned_count></assigned_count></span>
            <span id='switch_total' class="badge badge-success"><switched_count></switched_count></span>
            <span class="badge badge-warning">Назначенных заявок сегодня:
                <span id="assigned_today_counter">{{ assigned_today }}</span></span>
            <span class="badge badge-success">Подключеных заявок сегодня: {{ switched_on_today }}</span>
            <span class="badge badge-info">Созданых заявок сегодня: {{ created_today_tickets }}</span>
        </p><!--label bar-->
    </div>
    <hr>
    <div class="container">
        <div class="progress" style="height: 30px;">
            <div id='switch_bar' class="progress-bar progress-bar-striped progress-bar-animated bg-success">
                Подключеных заявок сегодня: {{ switched_on_today }}
            </div>
            <div id='assign_bar' class="progress-bar progress-bar-striped progress-bar-animated bg-warning">
                Назначенных заявок сегодня: {{ assigned_today }}
            </div>
            <br>
        </div>
    </div>
    <hr>
    <div class="container">
        <input class="form-control" id="myInput" type="text" placeholder="Search..">
    </div>
    <hr>
    <ol class="breadcrumb my-4">
        <li class="breadcrumb-item active"><span class="label label-danger">Назначенные в график: </span>
            <result_assign></result_assign>
        </li>
    </ol>
    <div class="container">
        <table id="assign_table" class="table table-hover table-bordered table-warning">
            <thead class="thead-inverse" style="background: #ffc620">
            <tr>
                <th>Номер заявки</th>
                <th>ФИО\Адресс</th>
                <th>Телефон</th>
                <th>Статус</th>
                <th>Таймер</th>
                <th>Сотрудник</th>
            </tr>
            </thead>
            <tbody id="myTable">
            {% for ticket in assigned_tickets %}
                <tr>
                    <td class="align-middle "><a href="{% url 'ticket_info' ticket.ticket_paired_info.id %}"
                                                 target="_blank">{{ ticket.ticket_paired_info.number }}</a>
                        <small class="text-muted d-block">{{ ticket.status }}</small>
                    </td>

                    <td>
                        <a class="align-middle">{{ ticket.name }}</a>
                        <small class="text-muted d-block">{{ ticket.address }} <b
                                style="color:red;">{{ ticket.dns }}</b> </small>
                        <small id="installer_comments_{{ ticket.ticket_paired_info.id }}">

                        </small>
                    </td>
                    <td>
                        <a class="align-middle" href="tel:8{{ ticket.phone1 }}">{{ ticket.phone1 }}</a>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone2 }}">{{ ticket.phone2 }}</a></small>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone3 }}">{{ ticket.phone3 }}</a></small>
                    </td>
                    <td class="align-middle">
                        {{ ticket.ticket_paired_info.status }}
                        <small class="text-muted d-block">
{#                            тариф#}
{#                            {{ ticket.services.IS_PRESET_name }}{{ ticket.services.IS_INAC_PRESET_name }}#}
                        </small>
                    </td>
                    <td class="align-middle">
                        {{ ticket.call_time }}
                        <small class="text-muted d-block"><abbr id="assign_date_{{ ticket.ticket_paired_info.id }}"
                                title="Последняя дата назначения">
{#                            {{ ticket.assigned_date }}#}
                        </abbr></small>
                    </td>
                    <td class="align-middle" data-operator="{{ ticket.operator }}">
                        {{ ticket.name_operator }}
                        <div class="input-group input-group-sm">
                            <select class="custom-select" style="background: transparent;"
                                    id="source_{{ ticket.ticket_paired_info.number }}">
                                <option>Не определено</option>
                                <option>Поквартирный обход</option>
                                <option>Обзвон</option>
                                <option>Залистовка</option>
                                <option>Другое</option>
                            </select>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button"
                                        onclick="sendSourceTicket(this, {{ ticket.ticket_paired_info.number }},
                                                document.getElementById('source_{{ ticket.ticket_paired_info.number }}')
                                                , '{{ csrf_token }}')">+
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <ol class="breadcrumb my-4">
        <li class="breadcrumb-item active"><span class="label label-danger">Перезвоны на сегодня: </span>
            <result_call></result_call>
        </li>
        <li class="ml-auto">
            <button class="btn btn-warning btn-sm" onclick="getCallTariff()"> Показать тарифы</button>
        </li>
    </ol>
    <div class="container">
        <table id="call_table" class="table table-hover table-bordered table-info">
            <thead class="thead-inverse" style="background: #00ecff">
            <tr>
                <th>Номер заявки</th>
                <th>ФИО\Адресс</th>
                <th>Телефон</th>
                <th>Статус</th>
                <th>Таймер</th>
                <th>Сотрудник</th>
            </tr>
            </thead>
            <tbody id="myTable">
            {% for ticket in call_for_today %}
                <tr>
                    <td class="align-middle "><a href="{% url 'ticket_info' ticket.ticket_paired_info.id %}"
                                                 target="_blank">{{ ticket.ticket_paired_info.number }}</a>
                        <small class="text-muted d-block"></small>
                    </td>
                    <td>
                        <a class="align-middle">{{ ticket.name }}</a>
                        <small class="text-muted d-block">{{ ticket.address }}</small>
                    </td>
                    <td>
                        <a class="align-middle" href="tel:8{{ ticket.phone1 }}">{{ ticket.phone1 }}</a>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone2 }}">{{ ticket.phone2 }}</a></small>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone3 }}">{{ ticket.phone3 }}</a></small>
                    </td>
                    <td class="align-middle">{{ ticket.ticket_paired_info.status }}
                        <small class="text-muted d-block" id="t_{{ ticket.id }}"></small>
                    </td>
                    <td class="align-middle">{{ ticket.ticket_paired_info.call_time }}</td>
                    <td class="align-middle" data-operator="{{ ticket.operator }}">{{ ticket.name_operator }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <ol class="breadcrumb my-4">
        <li class="breadcrumb-item active"><span class="label label-danger">Подключенные: </span>
            <result_switch></result_switch>
        </li>
        <li class="ml-auto">
            <button class="btn btn-warning btn-sm" onclick="getSwitchedTariff()"> Показать тарифы</button>
        </li>
    </ol>
    <div class="container">
        <table id="switch_table" class="table table-hover table-bordered table-success">
            <thead class="thead-inverse" style="background: #a3ff0a">
            <tr>
                <th>Номер заявки</th>
                <th>ФИО\Адресс</th>
                <th>Телефон</th>
                <th>Статус</th>
                <th>Таймер</th>
                <th>Сотрудник</th>
            </tr>
            </thead>
            <tbody id="myTable">
            {% for ticket in switched_on_tickets %}
                <tr>
                    <td class="align-middle "><a href="{% url 'ticket_info' ticket.ticket_paired_info.id %}"
                                                 target="_blank">{{ ticket.ticket_paired_info.number }}</a>
                        <small class="text-muted d-block"><a href="{% url 'ticket_info' ticket.id %}"
                                                             target="_blank">{{ ticket.number }}</a></small>
                    </td>
                    <td>
                        <a class="align-middle">{{ ticket.name }}</a>
                        <small class="text-muted d-block">{{ ticket.address }} <b
                                style="color:red;">{{ ticket.dns }}</b></small>
                    </td>
                    <td>
                        <a class="align-middle" href="tel:8{{ ticket.phone1 }}">{{ ticket.phone1 }}</a>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone2 }}">{{ ticket.phone2 }}</a></small>
                        <small class="text-muted d-block"><a
                                href="tel:8{{ ticket.phone3 }}">{{ ticket.phone3 }}</a></small>
                    </td>
                    <td class="align-middle">
                        {{ ticket.ticket_paired_info.status }}
                        <small class="text-muted d-block" id="t_{{ ticket.id }}"></small>
                    </td>
                    <td class="align-middle">{{ ticket.ticket_paired_info.call_time }}</td>
                    <td class="align-middle" data-operator="{{ ticket.operator }}">
                        {{ ticket.name_operator }}
                        <div class="input-group input-group-sm">
                            <select class="custom-select" style="background: transparent;"
                                    id="source_{{ ticket.ticket_paired_info.number }}">
                                <option>Не определено</option>
                                <option>Поквартирный обход</option>
                                <option>Обзвон</option>
                                <option>Залистовка</option>
                                <option>Другое</option>
                            </select>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button"
                                        onclick="sendSourceTicket(this, {{ ticket.ticket_paired_info.number }},
                                                document.getElementById('source_{{ ticket.ticket_paired_info.number }}')
                                                , '{{ csrf_token }}')">+
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
{% block extra_scripts %}
    <script src="{% static 'js/beeline_js/index.js' %}"></script>
    <script>
        $(function () {
            $('#call_table').excelTableFilter();
            searchLine();
            assignCounter();
            switchCounter();
        });
        let assign_total = {{ assigned_today }};
        let switch_total = {{ switched_on_today }};
        let swAndAssign = assign_total + switch_total;
        let assign_bar = document.getElementById('assign_bar');
        let switch_bar = document.getElementById('switch_bar');
        switch_bar.style.width = (switch_total / swAndAssign) * 100 + '%';
        assign_bar.style.width = (assign_total / swAndAssign) * 100 + '%';
        getCallTariff = () => {
            {% for ticket in call_for_today %}
                getTicketInfo({{ticket.id}});
            {% endfor %}
        };
        getSwitchedTariff = () => {
            {% for ticket in switched_on_tickets %}
                getTicketInfo({{ticket.id}});
            {% endfor %}
        };
        //show source for all switched tickets and assigned
        let promise1 = new Promise(function (resolve, reject) {
            {% for ticket in assigned_tickets %}
                showSourceTicket({{ticket.ticket_paired_info.number}});
                autoUpdateInstallerComments({{ ticket.ticket_paired_info.id }});
            {% endfor %}
        });
        promise1.then(function () {
            getCountAssigned();
        });
        {% for ticket in switched_on_tickets %}
            showSourceTicket({{ticket.ticket_paired_info.number}});
        {% endfor %}

    </script>
{% endblock %}













